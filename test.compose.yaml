services:
  sut:
    image: ubuntu:22.04
    command: "true"
    depends_on:
      sut-minimal:
        condition: service_completed_successfully
      sut-basic:
        condition: service_completed_successfully

  sut-minimal:
    image: ubuntu:22.04
    command: "true"
    depends_on:
      sut-minimal-1:
        condition: service_completed_successfully

  sut-basic:
    image: ubuntu:22.04
    command: "true"
    depends_on:
      sut-basic-1:
        condition: service_completed_successfully

  sut-small:
    image: ubuntu:22.04
    command: "true"

  sut-medium:
    image: ubuntu:22.04
    command: "true"

  sut-full:
    image: ubuntu:22.04
    command: "true"

  sut-minimal-1:
    image: ${IMAGE_ID}:${VERSION}-minimal
    command: |
      sh -c '
      set -e

      # check if some basic commands work
      tlmgr --version
      pdftex -v
      tex -v
      bibtex -v

      # check if installation works correctly
      latexmk -v && exit 1
      tlmgr install latexmk
      latexmk -v || exit 1

      echo Tests passed!
      '
      
  sut-basic-1:
    image: ${IMAGE_ID}:${VERSION}-basic
    command: |
      sh -c '
      set -ex
      cd /tmp

      echo "=== STEP 1: Verifica ambiente base ==="
      pwd
      ls -la
      whoami
      
      echo "=== STEP 2: Verifica connessione di rete ==="
      cat /etc/resolv.conf
      ping -c 2 mirror.ctan.org || echo "Ping failed but continuing..."
      nslookup mirror.ctan.org || echo "DNS lookup failed but continuing..."
      
      echo "=== STEP 3: Verifica tlmgr ==="
      which tlmgr
      tlmgr --version
      echo "PATH: $PATH"
      
      echo "=== STEP 4: Verifica repository configurato ==="
      tlmgr option repository
      
      echo "=== STEP 5: Test download diretto ==="
      wget --timeout=30 --tries=2 https://mirror.ctan.org/systems/texlive/tlnet/archive/latexmk.tar.xz -O /tmp/latexmk.tar.xz
      echo "wget exit code: $?"
      ls -la /tmp/latexmk.tar.xz || echo "File non scaricato"
      
      echo "=== STEP 6: Aggiorna repository ==="
      tlmgr option repository https://mirror.ctan.org/systems/texlive/tlnet/
      tlmgr option repository
      
      echo "=== STEP 7: Prova installazione latexmk ==="
      tlmgr install latexmk --verify-repo=n --dry-run
      tlmgr install latexmk --verify-repo=n
      echo "tlmgr install exit code: $?"
      
      echo "=== STEP 8: Test compilazione ==="
      echo "\documentclass[12pt]{article}" > main.tex
      echo "\begin{document}" >> main.tex
      echo "test" >> main.tex
      echo "\end{document}" >> main.tex
      
      latexmk -pdf main.tex
      ls -la main.pdf

      echo "âœ… TUTTI I TEST PASSATI!"
      '
    network_mode: "bridge"  # Forza la rete di default
